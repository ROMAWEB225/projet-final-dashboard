<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage HR - Manager</title>

 <style>
  :root{
  --primary: #8b0000;   /* rouge foncé */
  --secondary: #333333; /* gris pur */
  --accent: #e74c3c;
  --light: #ffffff;
  --muted: #f5f5f5;
  --success: #2ecc71;
  --warning: #f39c12;
  --danger: #c0392b;
  --glass: rgba(255,255,255,0.06);
}

/* Reset & base */
*{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
body{background:var(--muted);color:var(--secondary);line-height:1.4;font-size:14px}
.container{display:flex;min-height:100vh;flex-direction:column}

/* Sidebar */
.sidebar{
  width:100%;
  background:var(--primary);
  color:var(--light);
  padding:12px 8px;
  display:flex;
  flex-direction:row;
  overflow-x:auto;
  gap:4px;
  order:1;
  z-index:1000;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.logo{font-weight:700;font-size:1rem;text-align:center;padding:8px 0;margin-right:12px;white-space:nowrap}
.nav{display:flex;flex-direction:row;gap:4px;flex:1;justify-content:space-around}
.menu-item{
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:center;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  color:var(--light);
  transition:background .18s, transform .08s;
  min-width:60px;
  text-align:center;
  flex-shrink:0;
}
.menu-item i{font-size:16px}
.menu-item span{font-weight:600;font-size:0.75rem;line-height:1.2}
.menu-item:hover{background:rgba(255,255,255,0.06);transform:translateY(-1px)}
.menu-item.active{background:var(--secondary);color:var(--light)}

/* Main content */
.main-content{
  flex:1;
  padding:16px;
  order:2;
  width:100%;
  overflow-x:auto;
}
.header{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:16px;
  border-bottom:1px solid #eee;
  padding-bottom:12px;
}
.header h1{font-size:1.5rem;color:var(--secondary);text-align:center}
.header-controls{display:flex;justify-content:center}
.header-controls input{
  padding:10px;
  border-radius:6px;
  border:1px solid #ddd;
  width:100%;
  max-width:400px;
}

/* Stats cards */
.stats-cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:12px;
  margin:16px 0;
}
.stat-card{
  background:var(--light);
  border-radius:8px;
  padding:12px;
  box-shadow:0 4px 8px rgba(0,0,0,0.05);
  text-align:center;
  min-height:100px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.stat-card h3{color:var(--primary);margin-bottom:8px;font-size:0.9rem}
.stat-card .number{font-size:24px;color:var(--secondary);font-weight:700}

/* Form sections */
.form-section{
  background:var(--light);
  padding:16px;
  border-radius:8px;
  box-shadow:0 4px 8px rgba(0,0,0,0.04);
  margin-bottom:16px;
  overflow-x:auto;
}
.form-section h2{
  margin-bottom:12px;
  color:var(--primary);
  padding-bottom:8px;
  border-bottom:1px solid #f2f2f2;
  font-size:1.2rem;
}
.form-row{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:12px;
}
.form-group{
  flex:1;
  min-width:100%;
}
.form-group label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  color:var(--secondary);
  font-size:0.9rem;
}
.form-group input,
.form-group select,
.form-group textarea{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid #e6e6e6;
  font-size:14px;
  background:#fff;
  color:var(--secondary);
  box-sizing:border-box;
}
.form-group textarea{min-height:80px;resize:vertical}
.select-hint{font-size:0.75rem;color:#666;margin-top:4px}

/* Buttons */
.btn{
  cursor:pointer;
  border-radius:6px;
  padding:10px 14px;
  font-weight:700;
  border:none;
  transition:all 0.2s;
  font-size:0.9rem;
  text-align:center;
  min-width:120px;
}
.btn-primary{background:var(--primary);color:var(--light)}
.btn-primary:hover{background:var(--secondary)}
.btn-edit{
  background:#3498db;
  color:white;
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:0.8rem;
  margin:2px;
  min-width:auto;
}
.btn-delete{
  background:#e74c3c;
  color:white;
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:0.8rem;
  margin:2px;
  min-width:auto;
}
.btn-status{
  background:#2ecc71;
  color:white;
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin:2px;
  font-size:0.8rem;
  min-width:auto;
}

/* Tables */
.data-table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:0.85rem;
  min-width:600px;
}
.data-table th,
.data-table td{
  padding:10px 8px;
  border-bottom:1px solid #f0f0f0;
  text-align:left;
  vertical-align:top;
}
.data-table th{
  background:transparent;
  color:var(--secondary);
  font-weight:700;
  font-size:0.9rem;
  white-space:nowrap;
}
.data-table tr:hover{background:#fafafa}
.vehicle-photo{
  width:60px;
  height:45px;
  object-fit:cover;
  border-radius:4px;
}

/* Status badges */
.status-badge{
  padding:4px 8px;
  border-radius:16px;
  font-weight:700;
  font-size:0.75rem;
  display:inline-block;
  text-align:center;
}
.status-en-cours{background:#ffeaa7;color:#d35400}
.status-termine{background:#d1f7c4;color:#27ae60}
.status-en-attente{background:#f1f2f6;color:#636e72}

/* small helpers */
.form-actions{
  margin-top:12px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:center;
}
.tab-content{display:none;width:100%}
.tab-content.active{display:block}
.action-buttons{
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:flex-start;
}

/* Notification */
.notification{
  position:fixed;
  right:10px;
  top:10px;
  padding:10px 14px;
  border-radius:6px;
  color:#fff;
  background:var(--success);
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  transform:translateX(120%);
  transition:transform 260ms ease;
  z-index:9999;
  max-width:calc(100% - 20px);
  font-size:0.9rem;
}
.notification.show{transform:translateX(0)}
.notification.error{background:var(--danger)}

/* Photo preview */
.photo-preview{
  width:100px;
  height:75px;
  object-fit:cover;
  border-radius:4px;
  margin-top:8px;
  border:1px solid #ddd;
  display:none;
  max-width:100%;
}

/* Search filters */
.search-filters{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-bottom:16px;
}

/* Traffic flow */
.traffic-flow{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin:12px 0;
}
.flow-card{
  background:var(--light);
  border-radius:8px;
  padding:12px;
  box-shadow:0 4px 8px rgba(0,0,0,0.06);
  flex:1;
}
.flow-card h3{
  color:var(--primary);
  margin-bottom:10px;
  font-size:1rem;
  text-align:center;
}
.flow-list{max-height:200px;overflow-y:auto}
.flow-item{
  padding:8px;
  border-bottom:1px solid #f0f0f0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:0.85rem;
}
.flow-item:last-child{border-bottom:none}
.flow-vehicle{font-weight:600;flex:1}
.flow-time{color:#666;font-size:0.8rem;margin-left:8px}

/* Modal */
.modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  z-index:10000;
  align-items:center;
  justify-content:center;
  padding:16px;
  box-sizing:border-box;
}
.modal-content{
  background:white;
  padding:20px;
  border-radius:8px;
  width:100%;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  border-bottom:1px solid #eee;
  padding-bottom:12px;
}
.modal-close{
  background:none;
  border:none;
  font-size:24px;
  cursor:pointer;
  color:#666;
  padding:0;
  width:30px;
  height:30px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* =========================== */
/* RESPONSIVE DESIGN */
/* =========================== */

/* Tablettes (768px et plus) */
@media (min-width: 768px) {
  body{font-size:15px}
  
  .container{flex-direction:row}
  
  .sidebar{
    width:220px;
    flex-direction:column;
    overflow-x:visible;
    overflow-y:auto;
    order:0;
    padding:16px 12px;
    gap:8px;
  }
  
  .nav{flex-direction:column;justify-content:flex-start;gap:4px}
  
  .menu-item{flex-direction:row;justify-content:flex-start;text-align:left;min-width:auto;padding:12px}
  
  .menu-item i{margin-right:8px;font-size:18px}
  
  .menu-item span{font-size:0.9rem}
  
  .main-content{padding:24px;order:1}
  
  .header{flex-direction:row;justify-content:space-between;align-items:center;text-align:left}
  
  .header h1{font-size:1.8rem;text-align:left}
  
  .stats-cards{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin:24px 0}
  
  .stat-card{padding:16px;min-height:120px}
  
  .stat-card .number{font-size:28px}
  
  .form-row{flex-direction:row;gap:16px}
  
  .form-group{min-width:0}
  
  .form-section{padding:20px;margin-bottom:20px}
  
  .form-section h2{font-size:1.3rem}
  
  .data-table{font-size:0.9rem}
  
  .data-table th, .data-table td{padding:12px 10px}
  
  .search-filters{flex-direction:row;align-items:flex-end;gap:16px}
  
  .traffic-flow{flex-direction:row;gap:16px}
  
  .flow-card{min-width:200px}
  
  .action-buttons{flex-direction:row;align-items:center}
  
  .btn-edit, .btn-delete, .btn-status{padding:8px 12px;font-size:0.85rem}
}

/* Grands écrans (1024px et plus) */
@media (min-width: 1024px) {
  body{font-size:16px}
  
  .sidebar{width:250px;padding:20px 16px}
  
  .main-content{padding:32px}
  
  .header h1{font-size:2rem}
  
  .stats-cards{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
  
  .stat-card .number{font-size:32px}
  
  .form-section{padding:24px;margin-bottom:24px}
  
  .form-section h2{font-size:1.4rem}
  
  .data-table{font-size:0.95rem}
  
  .data-table th, .data-table td{padding:14px 12px}
}

/* Très petits écrans (480px et moins) */
@media (max-width: 480px) {
  body{font-size:13px}
  
  .main-content{padding:12px}
  
  .header{padding-bottom:8px;margin-bottom:12px}
  
  .header h1{font-size:1.3rem}
  
  .stats-cards{grid-template-columns:1fr;gap:10px;margin:12px 0}
  
  .stat-card{padding:10px;min-height:80px}
  
  .stat-card .number{font-size:20px}
  
  .form-section{padding:12px;margin-bottom:12px}
  
  .form-section h2{font-size:1.1rem;margin-bottom:10px}
  
  .btn{min-width:100px;padding:8px 12px;font-size:0.85rem}
  
  .form-actions{justify-content:stretch}
  
  .form-actions .btn{flex:1;min-width:0}
  
  .data-table{font-size:0.8rem;min-width:500px}
  
  .data-table th, .data-table td{padding:8px 6px}
  
  .vehicle-photo{width:50px;height:35px}
  
  .modal-content{padding:16px;margin:10px}
  
  .menu-item{padding:6px 8px;min-width:50px}
  
  .menu-item i{font-size:14px}
  
  .menu-item span{font-size:0.7rem}
}

/* Orientation paysage sur mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .sidebar{overflow-y:auto;max-height:100vh}
  
  .main-content{padding:12px}
  
  .stat-card{min-height:70px;padding:8px}
  
  .form-section{padding:12px}
}

/* Amélioration de l'accessibilité tactile */
@media (hover: none) and (pointer: coarse) {
  .menu-item:hover{background:transparent;transform:none}
  
  .menu-item:active{background:rgba(255,255,255,0.06);transform:scale(0.98)}
  
  .btn{padding:12px 14px;min-height:44px}
  
  .form-group input, 
  .form-group select, 
  .form-group textarea{min-height:44px}
}
</style>
</head>
  
<body>
  <div id="notification" class="notification"></div>

  <!-- Modal pour modifier une intervention -->
  <div id="intervention-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Modifier l'intervention</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="edit-intervention-form">
        <input type="hidden" id="edit-intervention-id">
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-vehicule">Véhicule</label>
            <select id="edit-vehicule" required>
              <option value="">Sélectionner un véhicule</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="edit-date">Date</label>
            <input type="date" id="edit-date" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-type">Type d'intervention</label>
            <input list="edit-types-intervention" id="edit-type" required />
            <datalist id="edit-types-intervention">
              <option value="Vidange">
              <option value="Réparation">
              <option value="Contrôle technique">
              <option value="Carrosserie">
              <option value="Électricité">
              <option value="Pneumatique">
              <option value="Freinage">
              <option value="Climatisation">
            </datalist>
          </div>
          
          <div class="form-group">
            <label for="edit-statut">Statut</label>
            <select id="edit-statut" required>
              <option value="en-attente">En attente</option>
              <option value="en-cours">En cours</option>
              <option value="termine">Terminé</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-mecaniciens">Mécaniciens</label>
            <select id="edit-mecaniciens" multiple style="height:120px">
              <option value="1">YOBOUET SYLVIN</option>
              <option value="2">KHALIL HUSSEIN</option>
              <option value="3">NIANKINE YOUSSOUF</option>
              <option value="4">OUATTARA ISSIF</option>
              <option value="5">BABA DRAMANE</option>
              <option value="6">KONE SAIDOU</option>
              <option value="7">TRAORE ABDELATIF</option>
              <option value="8">KOUAME K WILLIAM</option>
              <option value="9">DIABATE HASSAN</option>
              <option value="10">MOHAMED</option>
              <option value="11">MANBONNE A AZIZ</option>
              <option value="12">TOUVOLI KEVIN</option>
              <option value="13">TOURE OTHNIEL</option>
              <option value="14">VEHI EBENEZER</option>
            </select>
            <div class="select-hint">Maintenez Ctrl/Cmd pour sélectionner plusieurs</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-pieces">Pièces utilisées</label>
            <textarea id="edit-pieces" placeholder="Liste des pièces utilisées..."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-observations">Observations</label>
            <textarea id="edit-observations" placeholder="Observations..."></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Mettre à jour</button>
          <button type="button" class="btn btn-delete" id="delete-intervention-btn">Supprimer</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation principale">
      <div class="logo"><span>HR MOTORS</span></div>

      <nav class="nav">
        <div class="menu-item active" data-tab="dashboard"><i>📊</i><span>Tableau de bord</span></div>
        <div class="menu-item" data-tab="vehicles"><i>🚗</i><span>Véhicules</span></div>
        <div class="menu-item" data-tab="interventions"><i>🔧</i><span>Interventions</span></div>
        <div class="menu-item" data-tab="traffic"><i>🚦</i><span>Flux véhicules</span></div>
        <div class="menu-item" data-tab="search"><i>🔍</i><span>Recherche</span></div>
        <div class="menu-item" data-tab="stats"><i>📈</i><span>Statistiques</span></div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <header class="header">
        <h1>Tableau de Bord - Garage HR</h1>
        <div class="header-controls">
          <input type="text" id="global-search" placeholder="Rechercher véhicule, intervention..." />
        </div>
      </header>

      <!-- Dashboard -->
      <section id="dashboard-tab" class="tab-content active">
        <div class="stats-cards">
          <div class="stat-card">
            <h3>Véhicules en garage</h3>
            <div class="number" id="vehicles-count">0</div>
          </div>
          <div class="stat-card">
            <h3>Interventions aujourd'hui</h3>
            <div class="number" id="interventions-today">0</div>
          </div>
          <div class="stat-card">
            <h3>Vidanges ce mois</h3>
            <div class="number" id="oil-changes-month">0</div>
          </div>
          <div class="stat-card">
            <h3>Réparations en cours</h3>
            <div class="number" id="repairs-in-progress">0</div>
          </div>
        </div>

        <div class="form-section">
          <h2>Activité récente</h2>
          <div style="overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Véhicule</th><th>Intervention</th><th>Mécanicien</th><th>Date</th><th>Statut</th><th>Action</th>
                </tr>
              </thead>
              <tbody id="recent-activity"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Vehicles -->
      <section id="vehicles-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouveau Véhicule</h2>
          <form id="vehicle-form">
            <div class="form-row">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" required />
              </div>
              <div class="form-group">
                <label for="modele">Modèle</label>
                <input type="text" id="modele" required />
              </div>
              <div class="form-group">
                <label for="couleur">Couleur</label>
                <input type="text" id="couleur" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="photo">Photo du véhicule</label>
                <input type="file" id="photo" accept="image/*" />
                <img id="photo-preview" class="photo-preview" alt="Aperçu de la photo">
              </div>
              <div class="form-group">
                <label for="proprietaire">Propriétaire</label>
                <input type="text" id="proprietaire" />
              </div>
              <div class="form-group">
                <label for="telephone">Téléphone</label>
                <input type="tel" id="telephone" />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Enregistrer le véhicule</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Liste des Véhicules</h2>
          <div style="overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr><th>Photo</th><th>Immatriculation</th><th>Modèle</th><th>Couleur</th><th>Propriétaire</th><th>Actions</th></tr>
              </thead>
              <tbody id="vehicles-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Interventions -->
      <section id="interventions-tab" class="tab-content">
        <div class="form-section">
          <h2>Nouvelle Intervention</h2>
          <form id="intervention-form">
            <div class="form-row">
              <div class="form-group">
                <label for="vehicule-intervention">Véhicule</label>
                <select id="vehicule-intervention" required>
                  <option value="">Sélectionner un véhicule</option>
                </select>
              </div>

              <div class="form-group">
                <label for="date-intervention">Date</label>
                <input type="date" id="date-intervention" required />
              </div>

              <div class="form-group">
                <label for="type-intervention">Type d'intervention</label>
                <input list="types-intervention" id="type-intervention" placeholder="Choisissez ou écrivez un type" required />
                <datalist id="types-intervention">
                  <option value="Vidange">
                  <option value="Réparation">
                  <option value="Contrôle technique">
                  <option value="Carrosserie">
                  <option value="Électricité">
                  <option value="Pneumatique">
                  <option value="Freinage">
                  <option value="Climatisation">
                </datalist>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="mecaniciens">Mécaniciens</label>
                <select id="mecaniciens" multiple style="height:120px">
                  <option value="1">YOBOUET SYLVIN</option>
                  <option value="2">KHALIL HUSSEIN</option>
                  <option value="3">NIANKINE YOUSSOUF</option>
                  <option value="4">OUATTARA ISSIF</option>
                  <option value="5">BABA DRAMANE</option>
                  <option value="6">KONE SAIDOU</option>
                  <option value="7">TRAORE ABDELATIF</option>
                  <option value="8">KOUAME K WILLIAM</option>
                  <option value="9">DIABATE HASSAN</option>
                  <option value="10">MOHAMED</option>
                  <option value="11">MANBONNE A AZIZ</option>
                  <option value="12">TOUVOLI KEVIN</option>
                  <option value="13">TOURE OTHNIEL</option>
                  <option value="14">VEHI EBENEZER</option>
                </select>
                <div class="select-hint">Maintenez Ctrl/Cmd pour sélectionner plusieurs</div>
              </div>

              <div class="form-group">
                <label for="pieces">Pièces utilisées</label>
                <textarea id="pieces" placeholder="Liste des pièces utilisées..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en-attente">En attente</option>
                  <option value="en-cours">En cours</option>
                  <option value="termine">Terminé</option>
                </select>
              </div>

              <div class="form-group">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Observations..."></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Enregistrer l'intervention</button>
            </div>
          </form>
        </div>

        <div class="form-section">
          <h2>Interventions Récentes</h2>
          <div style="overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr><th>Véhicule</th><th>Date</th><th>Type</th><th>Mécaniciens</th><th>Statut</th><th>Actions</th></tr>
              </thead>
              <tbody id="interventions-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Flux véhicules -->
      <section id="traffic-tab" class="tab-content">
        <div class="form-section">
          <h2>Flux des Véhicules - Aujourd'hui</h2>
          <div class="traffic-flow">
            <div class="flow-card">
              <h3>🚗 Véhicules entrés</h3>
              <div class="flow-list" id="vehicles-entered"></div>
            </div>
            <div class="flow-card">
              <h3>⏳ En réparation</h3>
              <div class="flow-list" id="vehicles-in-progress"></div>
            </div>
            <div class="flow-card">
              <h3>✅ Véhicules sortis</h3>
              <div class="flow-list" id="vehicles-exited"></div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Historique du flux</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="traffic-date">Date</label>
              <input type="date" id="traffic-date" />
            </div>
            <div class="form-actions">
              <button id="view-traffic" class="btn btn-primary">Voir le flux</button>
            </div>
          </div>
          <div class="traffic-flow" id="historical-traffic"></div>
        </div>
      </section>

      <!-- Search -->
      <section id="search-tab" class="tab-content">
        <div class="form-section">
          <h2>Recherche de Véhicules</h2>
          <div class="search-filters">
            <input type="text" id="search-immatriculation" placeholder="Immatriculation" />
            <input type="text" id="search-modele" placeholder="Modèle" />
            <input type="text" id="search-couleur" placeholder="Couleur" />
            <input type="date" id="search-date" />
            <select id="search-type">
              <option value="">Type d'intervention</option>
              <option value="Vidange">Vidange</option>
              <option value="Réparation">Réparation</option>
              <option value="Contrôle technique">Contrôle technique</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="search-button" class="btn btn-primary">Rechercher</button>
          </div>
        </div>

        <div class="form-section">
          <h2>Résultats de la Recherche</h2>
          <div style="overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr><th>Photo</th><th>Immatriculation</th><th>Modèle</th><th>Couleur</th><th>Propriétaire</th><th>Date entrée</th><th>Dernière intervention</th></tr>
              </thead>
              <tbody id="search-results"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Stats -->
      <section id="stats-tab" class="tab-content">
        <div class="form-section">
          <h2>Statistiques des interventions</h2>
          <div class="stats-cards">
            <div class="stat-card">
              <h3>Total interventions</h3>
              <div class="number" id="total-interventions">0</div>
            </div>
            <div class="stat-card">
              <h3>Vidanges ce mois</h3>
              <div class="number" id="month-oil-changes">0</div>
            </div>
            <div class="stat-card">
              <h3>Taux de completion</h3>
              <div class="number" id="completion-rate">0%</div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Réparations par mécanicien</h2>
          <div style="overflow-x:auto;">
            <table class="data-table">
              <thead><tr><th>Mécanicien</th><th>Interventions</th><th>En cours</th><th>Terminées</th></tr></thead>
              <tbody id="mechanics-stats"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

<script>
  // Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDgvf6KnIvbbpllpN35b4vJ21J8zvvuUUw",
  authDomain: "dashboard-hr-garage.firebaseapp.com",
  projectId: "dashboard-hr-garage",
  storageBucket: "dashboard-hr-garage.firebasestorage.app",
  messagingSenderId: "187836950909",
  appId: "1:187836950909:web:cbb64faf9f7c8821a70414"
};

// Init Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// Local state
let vehicles = [];
let interventions = [];

// DOM elems
const notification = document.getElementById('notification');

// Init when DOM ready
document.addEventListener('DOMContentLoaded', () => {
  initApp();
  loadData();
  setupEventListeners();
});

function initApp(){
  // set default date
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('date-intervention');
  const trafficDateInput = document.getElementById('traffic-date');
  if(dateInput) dateInput.value = today;
  if(trafficDateInput) trafficDateInput.value = today;
}

// Load from Firestore
async function loadData(){
  try {
    const vehiclesSnapshot = await db.collection('vehicles').get();
    vehicles = vehiclesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const interventionsSnapshot = await db.collection('interventions').get();
    interventions = interventionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    updateUI();
  } catch (err) {
    console.error("Load error", err);
    showNotification("Erreur de chargement des données", "error");
  }
}

function setupEventListeners(){
  // sidebar nav
  document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function(){
      switchTab(this.dataset.tab);
      document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
      this.classList.add('active');
      
      if(this.dataset.tab !== 'vehicles' && document.getElementById('vehicle-form').dataset.editingId) {
        resetVehicleForm();
      }
    });
  });

  // forms
  const vehicleForm = document.getElementById('vehicle-form');
  if(vehicleForm) vehicleForm.addEventListener('submit', e => { e.preventDefault(); addVehicle(); });

  const interventionForm = document.getElementById('intervention-form');
  if(interventionForm) interventionForm.addEventListener('submit', e => { e.preventDefault(); addIntervention(); });

  const editInterventionForm = document.getElementById('edit-intervention-form');
  if(editInterventionForm) editInterventionForm.addEventListener('submit', e => { e.preventDefault(); updateIntervention(); });

  // photo preview
  const photoInput = document.getElementById('photo');
  if(photoInput) photoInput.addEventListener('change', handlePhotoPreview);

  // search
  const searchBtn = document.getElementById('search-button');
  if(searchBtn) searchBtn.addEventListener('click', performSearch);

  const globalSearch = document.getElementById('global-search');
  if(globalSearch) globalSearch.addEventListener('input', e => performGlobalSearch(e.target.value));

  // traffic flow
  const viewTrafficBtn = document.getElementById('view-traffic');
  if(viewTrafficBtn) viewTrafficBtn.addEventListener('click', viewHistoricalTraffic);

  // modal
  const modalClose = document.querySelector('.modal-close');
  if(modalClose) modalClose.addEventListener('click', closeModal);

  const modal = document.getElementById('intervention-modal');
  if(modal) modal.addEventListener('click', function(e) {
    if(e.target === this) closeModal();
  });

  // delete intervention button
  const deleteInterventionBtn = document.getElementById('delete-intervention-btn');
  if(deleteInterventionBtn) deleteInterventionBtn.addEventListener('click', deleteIntervention);
}

function switchTab(tabName){
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const el = document.getElementById(`${tabName}-tab`);
  if(el) el.classList.add('active');
  
  if(tabName === 'traffic') {
    updateTrafficFlow();
  }
}

function handlePhotoPreview(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('photo-preview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    preview.style.display = 'none';
  }
}

async function uploadPhoto(file, vehicleId) {
  try {
    const storageRef = storage.ref();
    const photoRef = storageRef.child(`vehicles/${vehicleId}/${file.name}`);
    const snapshot = await photoRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();
    return downloadURL;
  } catch (error) {
    console.error("Erreur d'upload de photo:", error);
    throw error;
  }
}

async function addVehicle(){
  const immatriculation = document.getElementById('immatriculation').value.trim();
  const modele = document.getElementById('modele').value.trim();
  const couleur = document.getElementById('couleur').value.trim();
  const proprietaire = document.getElementById('proprietaire').value.trim();
  const telephone = document.getElementById('telephone').value.trim();
  const photoInput = document.getElementById('photo');
  const editingId = document.getElementById('vehicle-form').dataset.editingId;

  if(!immatriculation || !modele) { 
    showNotification("Immatriculation et modèle requis", "error"); 
    return; 
  }

  if (vehicles.some(v => v.immatriculation === immatriculation && v.id !== editingId)) {
    showNotification("Cette immatriculation est déjà utilisée!", "error");
    return;
  }

  let photoUrl = 'https://via.placeholder.com/100x70?text=Vehicle';
  
  if(photoInput && photoInput.files && photoInput.files[0]) {
    try {
      const vehicleId = editingId || 'temp_' + Date.now();
      photoUrl = await uploadPhoto(photoInput.files[0], vehicleId);
    } catch (error) {
      showNotification("Erreur lors de l'upload de la photo", "error");
      return;
    }
  } else if (editingId) {
    const existingVehicle = vehicles.find(v => v.id === editingId);
    if (existingVehicle) {
      photoUrl = existingVehicle.photo;
    }
  }

  const vehicleData = {
    immatriculation, 
    modele, 
    couleur, 
    proprietaire, 
    telephone, 
    photo: photoUrl, 
    dateAjout: new Date().toISOString()
  };

  try {
    if (editingId) {
      await db.collection('vehicles').doc(editingId).update(vehicleData);
      const index = vehicles.findIndex(v => v.id === editingId);
      if (index !== -1) {
        vehicles[index] = { ...vehicles[index], ...vehicleData };
      }
      showNotification("Véhicule modifié avec succès!");
    } else {
      const docRef = await db.collection('vehicles').add(vehicleData);
      vehicleData.id = docRef.id;
      vehicles.push(vehicleData);
      showNotification("Véhicule ajouté avec succès!");
    }
    
    updateUI();
    resetVehicleForm();
  } catch (err) {
    console.error(err);
    showNotification("Erreur lors de l'opération", "error");
  }
}

function resetVehicleForm() {
  document.getElementById('vehicle-form').reset();
  delete document.getElementById('vehicle-form').dataset.editingId;
  document.querySelector('#vehicle-form button[type="submit"]').textContent = 'Enregistrer le véhicule';
  document.getElementById('photo-preview').style.display = 'none';
}

async function addIntervention(){
  const vehiculeId = document.getElementById('vehicule-intervention').value;
  const date = document.getElementById('date-intervention').value;
  const type = document.getElementById('type-intervention').value.trim();
  const mecaniciensElements = document.getElementById('mecaniciens');
  const pieces = document.getElementById('pieces').value.trim();
  const statut = document.getElementById('statut').value;
  const observations = document.getElementById('observations').value.trim();

  if(!vehiculeId){ showNotification("Sélectionner un véhicule", "error"); return; }
  if(!date || !type){ showNotification("Date et type requis", "error"); return; }

  const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);

  const vehicle = vehicles.find(v => v.id == vehiculeId);
  if(!vehicle){ showNotification("Véhicule introuvable", "error"); return; }

  const newIntervention = {
    vehiculeId: vehicle.id,
    immatriculation: vehicle.immatriculation,
    modele: vehicle.modele,
    date, type, mecaniciens, pieces, statut, observations,
    dateCreation: new Date().toISOString()
  };

  try {
    const docRef = await db.collection('interventions').add(newIntervention);
    newIntervention.id = docRef.id;
    interventions.push(newIntervention);
    updateUI();
    document.getElementById('intervention-form').reset();
    document.getElementById('date-intervention').value = new Date().toISOString().split('T')[0];
    showNotification("Intervention enregistrée avec succès!");
  } catch (err) {
    console.error(err);
    showNotification("Erreur lors de l'ajout de l'intervention", "error");
  }
}

// Modifier complètement une intervention
async function updateIntervention() {
  const interventionId = document.getElementById('edit-intervention-id').value;
  const vehiculeId = document.getElementById('edit-vehicule').value;
  const date = document.getElementById('edit-date').value;
  const type = document.getElementById('edit-type').value.trim();
  const statut = document.getElementById('edit-statut').value;
  const mecaniciensElements = document.getElementById('edit-mecaniciens');
  const pieces = document.getElementById('edit-pieces').value.trim();
  const observations = document.getElementById('edit-observations').value.trim();

  if(!vehiculeId || !date || !type){ 
    showNotification("Véhicule, date et type requis", "error"); 
    return; 
  }

  const mecaniciens = Array.from(mecaniciensElements.selectedOptions).map(o => o.text);

  try {
    const updateData = {
      vehiculeId,
      date,
      type,
      statut,
      mecaniciens,
      pieces,
      observations,
      dateModification: new Date().toISOString()
    };

    // Mettre à jour l'immatriculation et le modèle si le véhicule a changé
    if (vehiculeId) {
      const vehicle = vehicles.find(v => v.id === vehiculeId);
      if (vehicle) {
        updateData.immatriculation = vehicle.immatriculation;
        updateData.modele = vehicle.modele;
      }
    }

    await db.collection('interventions').doc(interventionId).update(updateData);

    // Mettre à jour localement
    const index = interventions.findIndex(i => i.id === interventionId);
    if (index !== -1) {
      interventions[index] = { ...interventions[index], ...updateData };
    }

    updateUI();
    closeModal();
    showNotification("Intervention modifiée avec succès!");
  } catch (error) {
    console.error(error);
    showNotification("Erreur lors de la modification", "error");
  }
}

// Supprimer une intervention
async function deleteIntervention() {
  const interventionId = document.getElementById('edit-intervention-id').value;
  
  if(!confirm("Êtes-vous sûr de vouloir supprimer cette intervention?")) return;
  
  try {
    await db.collection('interventions').doc(interventionId).delete();
    interventions = interventions.filter(i => i.id !== interventionId);
    updateUI();
    closeModal();
    showNotification("Intervention supprimée avec succès");
  } catch(error) {
    console.error(error);
    showNotification("Erreur lors de la suppression", "error");
  }
}

// Ouvrir le modal pour modifier une intervention
function openEditInterventionModal(interventionId) {
  const intervention = interventions.find(i => i.id === interventionId);
  if (!intervention) return;

  // Remplir le formulaire avec les données de l'intervention
  document.getElementById('edit-intervention-id').value = interventionId;
  document.getElementById('edit-date').value = intervention.date;
  document.getElementById('edit-type').value = intervention.type;
  document.getElementById('edit-statut').value = intervention.statut;
  document.getElementById('edit-pieces').value = intervention.pieces || '';
  document.getElementById('edit-observations').value = intervention.observations || '';

  // Remplir la liste des véhicules
  const vehicleSelect = document.getElementById('edit-vehicule');
  vehicleSelect.innerHTML = '<option value="">Sélectionner un véhicule</option>';
  vehicles.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.id;
    opt.textContent = `${v.immatriculation} - ${v.modele}`;
    if (v.id === intervention.vehiculeId) {
      opt.selected = true;
    }
    vehicleSelect.appendChild(opt);
  });

  // Sélectionner les mécaniciens
  const mechanicsSelect = document.getElementById('edit-mecaniciens');
  Array.from(mechanicsSelect.options).forEach(opt => {
    opt.selected = intervention.mecaniciens.includes(opt.text);
  });

  document.getElementById('intervention-modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('intervention-modal').style.display = 'none';
}

// Les autres fonctions restent similaires mais adaptées au responsive...
// [Le reste du code JavaScript reste essentiellement le même mais optimisé pour le responsive]

// Search by filters
function performSearch(){
  const immatriculation = (document.getElementById('search-immatriculation').value || '').toLowerCase();
  const modele = (document.getElementById('search-modele').value || '').toLowerCase();
  const couleur = (document.getElementById('search-couleur').value || '').toLowerCase();
  const date = document.getElementById('search-date').value;
  const type = document.getElementById('search-type').value;

  let results = vehicles.slice();

  if(immatriculation) results = results.filter(v => v.immatriculation.toLowerCase().includes(immatriculation));
  if(modele) results = results.filter(v => v.modele.toLowerCase().includes(modele));
  if(couleur) results = results.filter(v => v.couleur.toLowerCase().includes(couleur));

  if(date || type) {
    const ids = interventions.filter(i => {
      let match = true;
      if(date) match = match && i.date === date;
      if(type) match = match && i.type === type;
      return match;
    }).map(i => i.vehiculeId);
    results = results.filter(v => ids.includes(v.id));
  }

  const resultsContainer = document.getElementById('search-results');
  resultsContainer.innerHTML = '';
  if(results.length === 0){
    resultsContainer.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucun résultat trouvé</td></tr>';
    return;
  }

  results.forEach(vehicle => {
    const lastIntervention = interventions
      .filter(i => i.vehiculeId === vehicle.id)
      .sort((a,b)=> new Date(b.date) - new Date(a.date))[0];

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo" onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'"></td>
      <td>${vehicle.immatriculation}</td>
      <td>${vehicle.modele}</td>
      <td>${vehicle.couleur}</td>
      <td>${vehicle.proprietaire || ''}</td>
      <td>${formatDate(vehicle.dateAjout)}</td>
      <td>${lastIntervention ? `${lastIntervention.type} (${formatDate(lastIntervention.date)})` : 'Aucune'}</td>
    `;
    resultsContainer.appendChild(tr);
  });
}

// Global search (simple)
function performGlobalSearch(query){
  if(!query || query.length < 2) return;
  query = query.toLowerCase();

  const results = [
    ...vehicles.filter(v => v.immatriculation.toLowerCase().includes(query) || v.modele.toLowerCase().includes(query) || (v.proprietaire || '').toLowerCase().includes(query)),
    ...interventions.filter(i => i.immatriculation.toLowerCase().includes(query) || (i.type || '').toLowerCase().includes(query) || i.mecaniciens.some(m => m.toLowerCase().includes(query))).map(i => vehicles.find(v=>v.id===i.vehiculeId)).filter(Boolean)
  ];

  const unique = [...new Map(results.map(r => [r.id, r])).values()];
  if(unique.length) showNotification(`${unique.length} résultat(s) trouvé(s) pour "${query}"`);
}

// Flux des véhicules
function updateTrafficFlow() {
  const today = new Date().toISOString().split('T')[0];
  
  const vehiclesEntered = interventions
    .filter(i => i.date === today)
    .map(i => {
      const vehicle = vehicles.find(v => v.id === i.vehiculeId);
      return vehicle ? { ...vehicle, intervention: i } : null;
    })
    .filter(Boolean)
    .filter((v, index, self) => self.findIndex(veh => veh.id === v.id) === index);

  const vehiclesInProgress = interventions
    .filter(i => i.statut === 'en-cours')
    .map(i => {
      const vehicle = vehicles.find(v => v.id === i.vehiculeId);
      return vehicle ? { ...vehicle, intervention: i } : null;
    })
    .filter(Boolean);

  const vehiclesExited = interventions
    .filter(i => i.statut === 'termine' && i.date === today)
    .map(i => {
      const vehicle = vehicles.find(v => v.id === i.vehiculeId);
      return vehicle ? { ...vehicle, intervention: i } : null;
    })
    .filter(Boolean);

  updateTrafficList('vehicles-entered', vehiclesEntered, 'entré');
  updateTrafficList('vehicles-in-progress', vehiclesInProgress, 'en cours');
  updateTrafficList('vehicles-exited', vehiclesExited, 'sorti');
}

function updateTrafficList(containerId, vehiclesList, status) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  if (vehiclesList.length === 0) {
    container.innerHTML = `<div class="flow-item">Aucun véhicule ${status}</div>`;
    return;
  }

  vehiclesList.forEach(vehicle => {
    const div = document.createElement('div');
    div.className = 'flow-item';
    div.innerHTML = `
      <div>
        <div class="flow-vehicle">${vehicle.immatriculation} - ${vehicle.modele}</div>
        <div class="flow-time">${vehicle.intervention ? vehicle.intervention.type : 'Nouveau véhicule'}</div>
      </div>
      <div>${formatTime(new Date())}</div>
    `;
    container.appendChild(div);
  });
}

function viewHistoricalTraffic() {
  const date = document.getElementById('traffic-date').value;
  if (!date) return;

  const historicalInterventions = interventions.filter(i => i.date === date);
  
  const entered = historicalInterventions
    .map(i => vehicles.find(v => v.id === i.vehiculeId))
    .filter(Boolean)
    .filter((v, index, self) => self.findIndex(veh => veh.id === v.id) === index);

  const inProgress = historicalInterventions
    .filter(i => i.statut === 'en-cours')
    .map(i => vehicles.find(v => v.id === i.vehiculeId))
    .filter(Boolean);

  const exited = historicalInterventions
    .filter(i => i.statut === 'termine')
    .map(i => vehicles.find(v => v.id === i.vehiculeId))
    .filter(Boolean);

  const historicalContainer = document.getElementById('historical-traffic');
  historicalContainer.innerHTML = `
    <div class="flow-card">
      <h3>🚗 Véhicules entrés (${date})</h3>
      <div class="flow-list">${formatHistoricalList(entered, 'entré')}</div>
    </div>
    <div class="flow-card">
      <h3>⏳ En réparation (${date})</h3>
      <div class="flow-list">${formatHistoricalList(inProgress, 'en cours')}</div>
    </div>
    <div class="flow-card">
      <h3>✅ Véhicules sortis (${date})</h3>
      <div class="flow-list">${formatHistoricalList(exited, 'sorti')}</div>
    </div>
  `;
}

function formatHistoricalList(vehiclesList, status) {
  if (vehiclesList.length === 0) {
    return `<div class="flow-item">Aucun véhicule ${status}</div>`;
  }

  return vehiclesList.map(vehicle => 
    `<div class="flow-item">
      <div class="flow-vehicle">${vehicle.immatriculation} - ${vehicle.modele}</div>
    </div>`
  ).join('');
}

// UI updates
function updateUI(){
  updateVehicleList();
  updateInterventionsList();
  updateVehicleSelect();
  updateStats();
  updateRecentActivity();
  updateTrafficFlow();
}

function updateVehicleList(){
  const container = document.getElementById('vehicles-list');
  container.innerHTML = '';
  if(vehicles.length === 0) { container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun véhicule enregistré</td></tr>'; return; }

  vehicles.forEach(vehicle => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${vehicle.photo}" class="vehicle-photo" alt="photo" onerror="this.src='https://via.placeholder.com/100x70?text=Vehicle'"></td>
      <td>${vehicle.immatriculation}</td>
      <td>${vehicle.modele}</td>
      <td>${vehicle.couleur}</td>
      <td>${vehicle.proprietaire || ''}</td>
      <td class="action-buttons">
        <button class="btn-edit" onclick="editVehicle('${vehicle.id}')">Modifier</button>
        <button class="btn-delete" onclick="deleteVehicle('${vehicle.id}')">Supprimer</button>
      </td>
    `;
    container.appendChild(tr);
  });
}

function updateInterventionsList(){
  const container = document.getElementById('interventions-list');
  container.innerHTML = '';
  if(interventions.length === 0) { container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucune intervention enregistrée</td></tr>'; return; }

  const sorted = [...interventions].sort((a,b)=> new Date(b.date) - new Date(a.date));
  sorted.forEach(i => {
    const vehicle = vehicles.find(v=>v.id===i.vehiculeId);
    if(!vehicle) return;
    const statusClass = `status-${i.statut}`;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${vehicle.immatriculation} (${vehicle.modele})</td>
      <td>${formatDate(i.date)}</td>
      <td>${i.type}</td>
      <td>${i.mecaniciens.join(', ')}</td>
      <td><span class="status-badge ${statusClass}">${i.statut}</span></td>
      <td class="action-buttons">
        <button class="btn-status" onclick="openEditInterventionModal('${i.id}')">Modifier</button>
        <button class="btn-edit" onclick="viewIntervention('${i.id}')">Détails</button>
      </td>
    `;
    container.appendChild(tr);
  });
}

function updateVehicleSelect(){
  const select = document.getElementById('vehicule-intervention');
  select.innerHTML = '<option value="">Sélectionner un véhicule</option>';
  vehicles.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.id;
    opt.textContent = `${v.immatriculation} - ${v.modele}`;
    select.appendChild(opt);
  });
}

function updateStats(){
  document.getElementById('vehicles-count').textContent = vehicles.length;
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('interventions-today').textContent = interventions.filter(i=>i.date===today).length;

  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const monthlyOil = interventions.filter(i=>{
    const d = new Date(i.date);
    return i.type.toLowerCase() === 'vidange' && d.getMonth()===currentMonth && d.getFullYear()===currentYear;
  }).length;
  document.getElementById('oil-changes-month').textContent = monthlyOil;

  document.getElementById('repairs-in-progress').textContent = interventions.filter(i=>i.statut==='en-cours').length;

  document.getElementById('total-interventions').textContent = interventions.length;
  document.getElementById('month-oil-changes').textContent = monthlyOil;
  const completed = interventions.filter(i=>i.statut==='termine').length;
  document.getElementById('completion-rate').textContent = interventions.length>0 ? `${Math.round((completed/interventions.length)*100)}%` : '0%';

  // stats by mechanic
  const mechanicsStats = {};
  interventions.forEach(i=>{
    (i.mecaniciens||[]).forEach(m=>{
      if(!mechanicsStats[m]) mechanicsStats[m] = { total:0, inProgress:0, completed:0 };
      mechanicsStats[m].total++;
      if(i.statut==='en-cours') mechanicsStats[m].inProgress++;
      if(i.statut==='termine') mechanicsStats[m].completed++;
    });
  });

  const container = document.getElementById('mechanics-stats');
  container.innerHTML = '';
  Object.keys(mechanicsStats).forEach(m=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td>${m}</td><td>${mechanicsStats[m].total}</td><td>${mechanicsStats[m].inProgress}</td><td>${mechanicsStats[m].completed}</td>`;
    container.appendChild(row);
  });
}

function updateRecentActivity(){
  const container = document.getElementById('recent-activity');
  container.innerHTML = '';
  const recent = [...interventions].sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,5);
  if(recent.length===0){ container.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucune activité récente</td></tr>'; return; }
  recent.forEach(i=>{
    const vehicle = vehicles.find(v=>v.id===i.vehiculeId);
    if(!vehicle) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${vehicle.immatriculation} (${vehicle.modele})</td>
      <td>${i.type}</td>
      <td>${i.mecaniciens.join(', ')}</td>
      <td>${formatDate(i.date)}</td>
      <td><span class="status-badge status-${i.statut}">${i.statut}</span></td>
      <td><button class="btn-status" onclick="openEditInterventionModal('${i.id}')">Modifier</button></td>
    `;
    container.appendChild(tr);
  });
}

// Edit & delete vehicles
async function editVehicle(id){
  const v = vehicles.find(x=>x.id===id);
  if(!v) return;
  
  document.getElementById('immatriculation').value = v.immatriculation;
  document.getElementById('modele').value = v.modele;
  document.getElementById('couleur').value = v.couleur;
  document.getElementById('proprietaire').value = v.proprietaire || '';
  document.getElementById('telephone').value = v.telephone || '';
  
  const preview = document.getElementById('photo-preview');
  if (v.photo && v.photo !== 'https://via.placeholder.com/100x70?text=Vehicle') {
    preview.src = v.photo;
    preview.style.display = 'block';
  }
  
  document.getElementById('vehicle-form').dataset.editingId = id;
  document.querySelector('#vehicle-form button[type="submit"]').textContent = 'Modifier le véhicule';
  
  showNotification("Modifiez le véhicule puis cliquez sur Modifier");
}

async function deleteVehicle(id, showNote = true){
  if(!confirm("Êtes-vous sûr de vouloir supprimer ce véhicule?")) return;
  try {
    await db.collection('vehicles').doc(id).delete();
    vehicles = vehicles.filter(v=>v.id!==id);

    const toDelete = interventions.filter(i=>i.vehiculeId===id);
    for(const it of toDelete){
      if(it.id) await db.collection('interventions').doc(it.id).delete();
    }
    interventions = interventions.filter(i=>i.vehiculeId!==id);

    updateUI();
    if(showNote) showNotification("Véhicule supprimé avec succès");
  } catch(err){
    console.error(err);
    showNotification("Erreur lors de la suppression", "error");
  }
}

function viewIntervention(id){
  const i = interventions.find(x=>x.id===id);
  if(!i) return;
  const v = vehicles.find(x=>x.id===i.vehiculeId);
  alert(`Détails de l'intervention:
Véhicule: ${v ? v.immatriculation + ' - ' + v.modele : 'N/A'}
Date: ${formatDate(i.date)}
Type: ${i.type}
Mécaniciens: ${i.mecaniciens.join(', ')}
Pièces: ${i.pieces || 'N/A'}
Statut: ${i.statut}
Observations: ${i.observations || 'N/A'}`);
}

// notifications
function showNotification(message, type="success"){
  const note = document.getElementById('notification');
  note.textContent = message;
  note.className = `notification ${type === 'error' ? 'error' : ''} show`;
  setTimeout(()=>{ note.classList.remove('show'); }, 3000);
}

function formatDate(dateString){
  const d = new Date(dateString);
  return d.toLocaleDateString('fr-FR');
}

function formatTime(date){
  return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

// expose some functions for inline onclick
window.editVehicle = editVehicle;
window.deleteVehicle = deleteVehicle;
window.viewIntervention = viewIntervention;
window.openEditInterventionModal = openEditInterventionModal;
</script>
</body>
</html>